<!-- User Message -->
<div *ngIf="message().role === 'user'" class="flex justify-end">
  <div class="max-w-[85%] md:max-w-[70%]">
    <div
      class="bg-primary text-vera-cream rounded-2xl rounded-tr-sm px-6 py-4 shadow-md"
    >
      <!-- Text/URL Content -->
      <p
        *ngIf="message().type !== 'image'"
        class="whitespace-pre-wrap break-words text-lg font-medium"
      >
        {{ message().content }}
      </p>

      <!-- Image Preview -->
      <div *ngIf="message().type === 'image'" class="space-y-2">
        <img
          [src]="message().imagePreview"
          class="max-h-64 rounded-lg border border-white/10"
          alt="Uploaded image"
        />
        <p class="text-xs text-vera-cream/70">{{ message().content }}</p>
      </div>
    </div>
  </div>
</div>

<!-- Vera Message -->
<div *ngIf="message().role === 'vera'" class="flex justify-start">
  <div class="max-w-[90%] md:max-w-[75%]">
    <!-- Loading State (No Bubble) -->
    <div
      *ngIf="message().isLoading"
      class="relative flex items-center justify-center w-12 h-12 ml-2"
    >
      <!-- Rotating Circle -->
      <div
        class="absolute inset-0 border-2 border-primary dark:border-vera-cream border-t-transparent dark:border-t-transparent rounded-full animate-spin"
      ></div>

      <!-- Logo -->
      <app-icon 
        [icon]="themeService.darkMode() ? 'logovVert' : 'logov'" 
        [width]="18" 
        [height]="18"
      ></app-icon>
    </div>

    <!-- Standard Message Bubble -->
    <div
      *ngIf="!message().isLoading"
      class="bg-vera-green text-primary rounded-2xl rounded-tl-sm px-6 py-5 shadow-md relative border border-gray-100 dark:border-gray-700 group"
    >
      <!-- Share Button -->
      <button
        (click)="shareMessage()"
        class="absolute top-2 right-2 p-2 text-gray-400 hover:text-primary dark:hover:text-white transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"
        [title]="copied() ? 'CopiÃ© !' : 'Partager'"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="24"
          height="24"
          viewBox="0 0 24 24"
        >
          <path
            fill="currentColor"
            d="M17 22q-1.25 0-2.125-.875T14 19q0-.15.075-.7L7.05 14.2q-.4.375-.925.588T5 15q-1.25 0-2.125-.875T2 12t.875-2.125T5 9q.6 0 1.125.213t.925.587l7.025-4.1q-.05-.175-.062-.337T14 5q0-1.25.875-2.125T17 2t2.125.875T20 5t-.875 2.125T17 8q-.6 0-1.125-.213T14.95 7.2l-7.025 4.1q.05.175.063.338T8 12t-.012.363t-.063.337l7.025 4.1q.4-.375.925-.587T17 16q1.25 0 2.125.875T20 19t-.875 2.125T17 22"
          />
        </svg>
      </button>

      <!-- Content -->
      <div>
        <p class="whitespace-pre-wrap leading-relaxed text-lg pr-8">
          {{ message().content }}
        </p>

        <!-- Links Cards -->
        <app-source-links [links]="message().links || []"></app-source-links>
      </div>
    </div>
  </div>
</div>
